<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Setlist Pro</title>
    
    <!-- Metadados de Compartilhamento (Open Graph / WhatsApp / Redes Sociais) -->
    <meta property="og:title" content="Setlist Pro">
    <meta property="og:description" content="Gerenciador de repert√≥rio e letras para m√∫sicos.">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Setlist Pro App">
    
    <!-- For√ßa a busca da imagem correta e ignora o cache antigo do WhatsApp -->
    <meta property="og:image" content="https://miguelangelodevads.github.io/setlist-pro/icon.png?v=novo_cache_1">
    <meta property="og:image:secure_url" content="https://miguelangelodevads.github.io/setlist-pro/icon.png?v=novo_cache_1">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="512">
    <meta property="og:image:height" content="512">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://miguelangelodevads.github.io/setlist-pro/icon.png?v=novo_cache_1">

    <!-- Configura√ß√£o do PWA e √çcone Interno -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script>
        const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><defs><linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#1a1a1a" /><stop offset="100%" stop-color="#000000" /></linearGradient></defs><rect width="512" height="512" rx="120" fill="url(#bg)"/><path d="M160 120 h130 l70 70 v200 a20 20 0 0 1 -20 20 h-180 a20 20 0 0 1 -20 -20 v-250 a20 20 0 0 1 20 -20 z" fill="#111" stroke="#00e676" stroke-width="24"/><text x="256" y="250" font-family="sans-serif" font-weight="900" font-size="72" fill="#ffffff" text-anchor="middle">SET</text><text x="256" y="320" font-family="sans-serif" font-weight="900" font-size="72" fill="#00e676" text-anchor="middle">LIST</text></svg>`;
        const iconUrl = 'data:image/svg+xml;base64,' + btoa(svgIcon);
        const linkIcon = document.createElement('link'); linkIcon.rel = 'icon'; linkIcon.href = iconUrl; document.head.appendChild(linkIcon);
        const appleIcon = document.createElement('link'); appleIcon.rel = 'apple-touch-icon'; appleIcon.href = iconUrl; document.head.appendChild(appleIcon);
        const manifest = { name: "Setlist Pro", short_name: "Setlist", start_url: window.location.href, display: "standalone", background_color: "#000000", theme_color: "#00e676", icons: [{ src: iconUrl, sizes: "512x512", type: "image/svg+xml" }] };
        const linkManifest = document.createElement('link'); linkManifest.rel = 'manifest'; linkManifest.href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'})); document.head.appendChild(linkManifest);
    </script>

    <style>
        :root {
            --bg-color: #000000;
            --surface: #121212;
            --accent: #00e676;
            --text-main: #ffffff;
            --text-dim: #888888;
            --nav-bg: #1c1c1e;
            --primary-grad: linear-gradient(135deg, #00b09b, #96c93d);
        }

        body {
            margin: 0; padding: 0; 
            background: radial-gradient(circle at top, #1a1a1a 0%, #000000 70%);
            background-color: #000;
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
            height: 100vh; width: 100vw; overflow: hidden;
            user-select: none; -webkit-user-select: none;
        }

        /* --- MENU HAMB√öRGUER --- */
        #menu-btn {
            position: absolute; top: 25px; left: 20px; z-index: 1000;
            background: none; border: none; cursor: pointer; padding: 10px;
        }
        .bar { width: 25px; height: 3px; background-color: var(--accent); margin: 5px 0; transition: 0.4s; border-radius: 2px; }

        #side-menu {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
            background-color: #111; z-index: 2000; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 5px 0 15px rgba(0,0,0,0.5); padding: 30px 20px; box-sizing: border-box;
            border-right: 1px solid #222;
        }
        #side-menu.open { left: 0; }
        #menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 1500; display: none; backdrop-filter: blur(3px);
        }
        .menu-title { font-size: 1.2rem; font-weight: 900; color: var(--accent); margin-bottom: 20px; text-transform: uppercase; border-bottom: 1px solid #222; padding-bottom: 10px; }
        
        .menu-list { overflow-y: auto; max-height: calc(100% - 100px); }
        .menu-item {
            padding: 15px; background: #181818; border-radius: 12px; margin-bottom: 10px;
            cursor: pointer; border: 1px solid #222; transition: 0.2s;
        }
        .menu-item:active { background: #222; }
        .menu-item-name { font-weight: bold; color: #fff; display: block; margin-bottom: 4px; }
        .menu-item-meta { font-size: 0.8rem; color: #666; }

        /* --- TELA INICIAL --- */
        #start-screen {
            display: flex; flex-direction: column; align-items: center; padding: 20px;
            height: 100%; box-sizing: border-box; overflow-y: auto;
        }
        
        .main-title { 
            margin: 40px 0 5px 0; font-weight: 900; font-size: 2.5rem; letter-spacing: -1px; 
            background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        }
        .subtitle { color: var(--text-dim); font-size: 0.9rem; margin-bottom: 25px; text-align: center; }
        
        .title-input {
            width: 100%; max-width: 500px; background: #111; color: var(--accent);
            border: 1px solid #222; border-radius: 16px; padding: 18px;
            font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; box-sizing: border-box;
            outline: none; text-align: center;
        }

        #setlist-input {
            width: 100%; max-width: 500px; height: 180px; background: #111;
            color: #fff; border: 1px solid #222; border-radius: 16px; padding: 18px;
            font-size: 1.1rem; resize: none; box-sizing: border-box; font-family: inherit;
            margin-bottom: 25px; line-height: 1.5; outline: none;
        }

        .voice-card { 
            width: 100%; max-width: 500px; background: #181818; padding: 20px; border-radius: 20px; 
            margin-bottom: 25px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center;
        }
        .voice-info { display: flex; flex-direction: column; gap: 4px; }
        .voice-label { font-size: 1.2rem; font-weight: bold; color: #fff; }
        .voice-warn { font-size: 0.95rem; color: #ff4400; font-weight: 500; }
        .voice-cmd { font-size: 0.95rem; color: var(--accent); font-weight: 500; }

        .switch-container { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .switch { position: relative; display: inline-block; width: 56px; height: 32px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(24px); }
        .toggle-status { font-size: 0.7rem; font-weight: 900; color: #444; text-transform: uppercase; transition: color 0.3s; }
        input:checked ~ .toggle-status { color: var(--accent); }
        
        .btn-go {
            width: 100%; max-width: 500px; padding: 22px; border-radius: 16px; border: none;
            background: var(--primary-grad); color: #000; font-weight: 900; font-size: 1.2rem; 
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
        }

        /* --- TELA DE PALCO --- */
        #app-content { display: none; width: 100%; height: 100%; position: relative; }
        #progress-header { position: absolute; top: 0; left: 0; height: 4px; background: var(--accent); width: 0%; z-index: 100; transition: width 0.3s; }
        .btn-exit-show { position: absolute; top: 20px; right: 20px; border-radius: 20px; border: 1px solid #333; background: rgba(255,255,255,0.05); color: #aaa; padding: 8px 16px; font-size: 0.9rem; font-weight: 600; cursor: pointer; z-index: 120; }

        #main-stage { position: absolute; inset: 0 0 100px 0; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        #stage-count { font-size: 1.1rem; color: var(--text-dim); font-weight: 700; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        #stage-current { font-size: 11vw; font-weight: 900; line-height: 1.1; color: #fff; margin-bottom: 20px; }
        #stage-next { font-size: 4.5vw; color: var(--accent); font-weight: 600; }

        #touch-prev { position: absolute; left: 0; width: 30%; top: 60px; bottom: 100px; z-index: 10; }
        #touch-next { position: absolute; right: 0; width: 70%; top: 60px; bottom: 100px; z-index: 10; }

        /* --- NAVBAR --- */
        .navbar-capsule { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--nav-bg); border-radius: 50px; display: flex; padding: 8px 15px; gap: 10px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); z-index: 150; border: 1px solid #2a2a2c; align-items: center; }
        .nav-btn { background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; min-width: 55px; cursor: pointer; padding: 8px 0; border-radius: 35px; }
        .nav-btn svg { width: 22px; height: 22px; margin-bottom: 5px; fill: none; stroke: currentColor; stroke-width: 2; }
        .nav-btn span { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #777; }
        .nav-btn.active-info { color: var(--accent); }
        .nav-btn.active-info span { color: var(--accent); }

        /* --- CORRE√á√ÉO DE RESPONSIVIDADE EM MODO PAISAGEM --- */
        @media (orientation: landscape) { 
            .navbar-capsule { display: none !important; } 
            #main-stage { inset: 0; padding-top: 30px; }
            #stage-count { font-size: 0.9rem; margin-bottom: 5px; }
            #stage-current { font-size: 14vh; margin-bottom: 10px; } 
            #stage-next { font-size: 7vh; }
            .btn-exit-show { top: 15px; right: 15px; padding: 6px 12px; font-size: 0.8rem; }
        }

        /* --- TELEPROMPTER --- */
        .fs-overlay { position: fixed; inset: 0; background: #000; z-index: 3000; display: none; flex-direction: column; padding: 25px; box-sizing: border-box; }
        .fs-head { display: flex; justify-content: center; align-items: center; border-bottom: 1px solid #1a1a1a; padding-bottom: 15px; transition: opacity 0.3s; }
        .fs-song { font-size: 1.5rem; color: var(--accent); font-weight: 900; text-align: center; text-transform: uppercase; line-height: 1.2; }
        .fs-body { flex-grow: 1; overflow-y: auto; padding: 30px 0; font-size: 8.5vw; font-weight: bold; line-height: 1.5; white-space: pre-wrap; text-align: center; color: #fff; cursor: pointer; }
        .fs-controls { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 10px; z-index: 310; transition: opacity 0.3s; }
        .speed-btn { background: rgba(255,255,255,0.1); border: 1px solid #333; color: #fff; width: 45px; height: 45px; border-radius: 50%; font-weight: bold; font-size: 20px; cursor: pointer; }
        .speed-indicator { font-size: 12px; color: var(--accent); text-align: center; font-weight: bold; }
        .fs-foot { display: flex; gap: 15px; padding-bottom: env(safe-area-inset-bottom); transition: opacity 0.3s; }
        .fs-action-btn { flex: 1; padding: 20px; border-radius: 16px; border: none; font-weight: 900; font-size: 1.1rem; cursor: pointer; text-transform: uppercase; }
        .btn-close { background: #222; color: #fff; }
        .btn-edit { background: var(--accent); color: #000; }
        .immersive-mode .fs-head, .immersive-mode .fs-foot, .immersive-mode .fs-controls { opacity: 0; pointer-events: none; }

        /* EDITOR MODAL */
        #editor-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 4000; display: none; flex-direction: column; padding: 30px; box-sizing: border-box; }
        .btn-search-web { background: #222; color: #fff; border: 1px solid #444; border-radius: 16px; padding: 15px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-bottom: 15px; text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 10px; transition: background 0.2s; }
        .btn-search-web:active { background: #333; }
        .btn-search-web:disabled { opacity: 0.5; cursor: not-allowed; }
        #editor-input { flex-grow: 1; background: #0a0a0a; color: #fff; border: 1px solid #333; border-radius: 16px; padding: 20px; font-size: 1.2rem; font-family: inherit; }
        .edit-btns { display: flex; gap: 15px; margin-top: 20px; }

        #toast { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 10px 25px; border-radius: 30px; font-weight: bold; opacity: 0; transition: 0.3s; z-index: 5000; font-size: 14px; }
    </style>
</head>
<body id="body-main">

    <!-- MENU HAMB√öRGUER -->
    <button id="menu-btn" aria-label="Menu">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </button>

    <div id="menu-overlay"></div>
    
    <div id="side-menu">
        <div class="menu-title">Shows Salvos</div>
        <div class="menu-list" id="menu-list"></div>
    </div>

    <!-- TELA INICIAL -->
    <div id="start-screen">
        <h1 class="main-title">Setlist Pro</h1>
        <div class="subtitle">Nome do show e lista de m√∫sicas</div>
        
        <input type="text" id="show-title-input" class="title-input" placeholder="Ex: Show Rock Bar">
        
        <textarea id="setlist-input" placeholder="Mulher de fases G&#10;Me lambe&#10;A mais pedida C&#10;Proibida pra mim"></textarea>

        <div class="voice-card">
            <div class="voice-info">
                <span class="voice-label">Comando de Voz</span>
                <span class="voice-warn">Desligue em palcos barulhentos</span>
                <span class="voice-cmd">Fale "pr√≥xima m√∫sica" para avan√ßar</span>
            </div>
            <div class="switch-container">
                <label class="switch">
                    <input type="checkbox" id="mic-toggle">
                    <span class="slider"></span>
                    <span class="toggle-status" id="mic-status-label">OFF</span>
                </label>
            </div>
        </div>

        <button class="btn-go" id="btn-start">INICIAR SHOW</button>
    </div>

    <!-- TELA DE PALCO -->
    <div id="app-content">
        <div id="progress-header"></div>
        <button class="btn-exit-show" id="btn-exit">Sair do Show</button>
        <div id="touch-prev"></div>
        <div id="touch-next"></div>
        <div id="main-stage">
            <div id="stage-count">M√öSICA 1 DE 1</div>
            <div id="stage-current">Nome da M√∫sica</div>
            <div id="stage-next">Pr√≥xima: ---</div>
        </div>
        <div class="navbar-capsule">
            <button class="nav-btn" id="nav-listen" title="Ouvir no YouTube">
                <svg viewBox="0 0 24 24"><path d="M3 18v-6a9 9 0 0 1 18 0v6"></path><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path></svg>
                <span>Ouvir</span>
            </button>
            <button class="nav-btn" id="nav-notes"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg><span>Notas</span></button>
            <button class="nav-btn" id="nav-lyrics"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg><span>Letra</span></button>
            <button class="nav-btn" id="nav-save"><svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path></svg><span>Salvar</span></button>
            <button class="nav-btn" id="nav-share"><svg viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg><span>Partilhar</span></button>
        </div>
    </div>

    <!-- TELA CHEIA (LETRAS / NOTAS) -->
    <div id="fs-view" class="fs-overlay">
        <div class="fs-head"><div id="fs-song-name" class="fs-song">M√∫sica Atual</div></div>
        <div id="fs-main-content" class="fs-body"></div>
        <div class="fs-controls">
            <button class="speed-btn" id="speed-up">+</button>
            <div class="speed-indicator"><span id="speed-val">0</span>x</div>
            <button class="speed-btn" id="speed-down">-</button>
        </div>
        <div class="fs-foot">
            <button class="fs-action-btn btn-close" id="fs-close">SAIR</button>
            <button class="fs-action-btn btn-edit" id="fs-edit">EDITAR</button>
        </div>
    </div>

    <!-- EDITOR MODAL -->
    <div id="editor-modal">
        <button class="btn-search-web" id="btn-search-web">üîç BUSCAR LETRA NA WEB</button>
        <textarea id="editor-input" placeholder="Digite aqui suas Notas"></textarea>
        <div class="edit-btns">
            <button class="fs-action-btn btn-close" onclick="document.getElementById('editor-modal').style.display='none'">Cancelar</button>
            <button class="fs-action-btn btn-edit" id="editor-save-btn">Guardar</button>
        </div>
    </div>

    <div id="toast">Msg</div>

    <script>
        let showData = { title: "", songs: [] };
        let currentIndex = 0;
        let wakeLock = null;
        let recognition = null;
        let activeMode = ""; 
        let scrollSpeed = 0;
        let scrollInterval = null;

        const startUI = document.getElementById('start-screen');
        const palcoUI = document.getElementById('app-content');
        const fsUI = document.getElementById('fs-view');
        const editorUI = document.getElementById('editor-modal');
        const fsContent = document.getElementById('fs-main-content');
        const btnSearchWeb = document.getElementById('btn-search-web');
        const menuBtn = document.getElementById('menu-btn');
        const sideMenu = document.getElementById('side-menu');
        const menuOverlay = document.getElementById('menu-overlay');
        const menuList = document.getElementById('menu-list');
        const micToggle = document.getElementById('mic-toggle');
        const micStatusLabel = document.getElementById('mic-status-label');

        // --- MANTER TELA ATIVA (WAKE LOCK ROBUSTO) ---
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    if (wakeLock !== null && !wakeLock.released) return; 
                    wakeLock = await navigator.wakeLock.request('screen');
                } catch (err) {
                    console.log("Erro WakeLock:", err);
                }
            }
        }

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && palcoUI.style.display === 'block') {
                requestWakeLock();
            }
        });

        document.addEventListener('touchstart', () => {
            if (palcoUI.style.display === 'block') requestWakeLock();
        }, { passive: true });
        
        document.addEventListener('click', () => {
            if (palcoUI.style.display === 'block') requestWakeLock();
        });

        // --- GESTOS DE SWIPE ---
        let touchstartX = 0;
        let touchendX = 0;

        function handleSwipe() {
            const threshold = 70;
            if (touchendX < touchstartX - threshold) {
                if (currentIndex < showData.songs.length - 1) {
                    currentIndex++;
                    updatePalco();
                    if(fsUI.style.display === 'flex') openFS(activeMode);
                }
            }
            if (touchendX > touchstartX + threshold) {
                if (currentIndex > 0) {
                    currentIndex--;
                    updatePalco();
                    if(fsUI.style.display === 'flex') openFS(activeMode);
                }
            }
        }

        fsContent.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, {passive: true});
        fsContent.addEventListener('touchend', e => { touchendX = e.changedTouches[0].screenX; handleSwipe(); }, {passive: true});

        // --- INTERRUPTOR MIC ---
        micToggle.addEventListener('change', () => {
            micStatusLabel.textContent = micToggle.checked ? "ON" : "OFF";
        });

        // --- MENU ---
        menuBtn.onclick = () => {
            sideMenu.classList.toggle('open');
            menuOverlay.style.display = sideMenu.classList.contains('open') ? 'block' : 'none';
            if(sideMenu.classList.contains('open')) renderMenuList();
        };

        menuOverlay.onclick = () => { sideMenu.classList.remove('open'); menuOverlay.style.display = 'none'; };

        function renderMenuList() {
            const list = JSON.parse(localStorage.getItem('saved_setlists_pro') || "[]");
            menuList.innerHTML = list.length ? "" : '<div style="color:#444; font-size:0.9rem;">Nenhum show salvo.</div>';
            list.slice(0, 15).forEach(s => {
                const item = document.createElement('div');
                item.className = 'menu-item';
                item.innerHTML = `<span class="menu-item-name">üéµ ${s.title}</span><span class="menu-item-meta">${s.songs.length} m√∫sicas</span>`;
                item.onclick = () => {
                    document.getElementById('show-title-input').value = s.title;
                    document.getElementById('setlist-input').value = s.songs.map(i => i.name).join('\n');
                    showData = JSON.parse(JSON.stringify(s));
                    sideMenu.classList.remove('open');
                    menuOverlay.style.display = 'none';
                    toast("Carregado!");
                };
                menuList.appendChild(item);
            });
        }

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('data')) {
                try {
                    const raw = JSON.parse(atob(decodeURIComponent(urlParams.get('data'))));
                    if (raw.t !== undefined && raw.s !== undefined) {
                        showData = { title: raw.t, songs: raw.s.map(s => ({ name: s.n, lyrics: s.l, notes: s.o })) };
                    } else {
                        showData = raw;
                    }
                    
                    document.getElementById('show-title-input').value = showData.title || "";
                    document.getElementById('setlist-input').value = showData.songs.map(s => s.name).join('\n');
                    toast("Show carregado!");
                    window.history.replaceState({}, '', window.location.pathname);
                } catch(e) {}
            }
        };

        function toast(m) { const t = document.getElementById('toast'); t.textContent = m; t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 2500); }

        function updatePalco() {
            if (currentIndex < showData.songs.length) {
                const song = showData.songs[currentIndex];
                document.getElementById('stage-count').textContent = `M√öSICA ${currentIndex + 1} DE ${showData.songs.length}`;
                document.getElementById('stage-current').textContent = song.name;
                document.getElementById('stage-next').textContent = showData.songs[currentIndex+1] ? "Pr√≥xima: " + showData.songs[currentIndex+1].name : "";
                document.getElementById('progress-header').style.width = `${((currentIndex + 1) / showData.songs.length) * 100}%`;
                document.getElementById('nav-lyrics').className = `nav-btn ${song.lyrics ? 'active-info' : ''}`;
                document.getElementById('nav-notes').className = `nav-btn ${song.notes ? 'active-info' : ''}`;
            } else {
                document.getElementById('stage-current').textContent = "FIM DO SHOW";
                document.getElementById('stage-next').textContent = "";
            }
        }

        document.getElementById('touch-next').onclick = () => { if (currentIndex < showData.songs.length) { currentIndex++; updatePalco(); } };
        document.getElementById('touch-prev').onclick = () => { if (currentIndex > 0) { currentIndex--; updatePalco(); } };

        document.getElementById('btn-exit').onclick = () => {
            palcoUI.style.display = 'none';
            startUI.style.display = 'flex';
            menuBtn.style.display = 'block';
            if (recognition) { recognition.onend = null; try { recognition.stop(); } catch(e){} }
            if (wakeLock !== null) { wakeLock.release().catch(()=>{}); wakeLock = null; }
        };

        function openFS(mode) {
            if (currentIndex >= showData.songs.length) return;
            activeMode = mode; stopAutoScroll(); fsUI.classList.remove('immersive-mode');
            const song = showData.songs[currentIndex];
            document.getElementById('fs-song-name').innerHTML = song.name;
            const content = mode === 'lyrics' ? song.lyrics : song.notes;
            fsContent.innerHTML = content || `<div style="color:#333; margin-top:100px;">Toque em EDITAR para adicionar informa√ß√µes.</div>`;
            fsContent.scrollTop = 0;
            document.querySelector('.fs-controls').style.display = mode === 'lyrics' ? 'flex' : 'none';
            fsUI.style.display = 'flex';
        }

        fsContent.onclick = (e) => { if (Math.abs(touchstartX - touchendX) < 10) fsUI.classList.toggle('immersive-mode'); };

        function startAutoScroll() {
            if (scrollInterval) clearInterval(scrollInterval);
            if (scrollSpeed === 0) return;
            scrollInterval = setInterval(() => {
                fsContent.scrollTop += 1;
                if (fsContent.scrollTop + fsContent.clientHeight >= fsContent.scrollHeight) stopAutoScroll();
            }, 100 / scrollSpeed);
        }

        function stopAutoScroll() { if (scrollInterval) clearInterval(scrollInterval); scrollInterval = null; }

        document.getElementById('speed-up').onclick = () => { scrollSpeed = Math.min(scrollSpeed + 1, 10); document.getElementById('speed-val').textContent = scrollSpeed; startAutoScroll(); };
        document.getElementById('speed-down').onclick = () => { scrollSpeed = Math.max(scrollSpeed - 1, 0); document.getElementById('speed-val').textContent = scrollSpeed; if (scrollSpeed === 0) stopAutoScroll(); else startAutoScroll(); };

        document.getElementById('nav-lyrics').onclick = () => openFS('lyrics');
        document.getElementById('nav-notes').onclick = () => openFS('notes');
        document.getElementById('fs-close').onclick = () => { stopAutoScroll(); fsUI.style.display = 'none'; };
        
        // --- BOT√ÉO DE OUVIR (YOUTUBE) ---
        document.getElementById('nav-listen').onclick = () => {
            if (currentIndex >= showData.songs.length) return;
            const songNameRaw = showData.songs[currentIndex].name;
            // Limpa o tom do fim do nome para facilitar a busca (ex: remove " C#m")
            const cleanName = songNameRaw.replace(/\s[A-G][#b]?m?$/i, '').trim();
            const query = encodeURIComponent(cleanName + " official audio");
            
            // Abre diretamente a pesquisa no YouTube. 
            // Em dispositivos m√≥veis, isto costuma abrir a App do YouTube automaticamente se estiver instalada.
            window.open(`https://www.youtube.com/results?search_query=${query}`, '_blank');
        };

        // --- FUN√á√ÉO PARA CORRIGIR CARACTERES ESTRANHOS (ENCODING) DA API ---
        const fixEncoding = (str) => {
            let fixed = str;
            try { fixed = decodeURIComponent(escape(str)); } catch (e) {}
            const replacements = {
                '√°¬™': '√™', '√É¬™': '√™', '√°¬°': '√°', '√É¬°': '√°', '√°¬∫': '√∫', '√É¬∫': '√∫',
                '√°¬¥': '√¥', '√É¬¥': '√¥', '√°¬ß': '√ß', '√É¬ß': '√ß', '√°¬£': '√£', '√É¬£': '√£',
                '√°¬©': '√©', '√É¬©': '√©', '√°¬≥': '√≥', '√É¬≥': '√≥', '√°¬µ': '√µ', '√É¬µ': '√µ',
                '√°¬¢': '√¢', '√É¬¢': '√¢', '√É‚Ä°': '√á', '√É∆í': '√É', '√É≈†': '√ä', '√É‚Ä∞': '√â',
                '√É‚Äú': '√ì', '√É‚Ä¢': '√ï', '√É≈°': '√ö', '√É‚Äö': '√Ç', 'H√°¬°': 'H√°',
                'voc√°¬™': 'voc√™', 't√°¬∫nel': 't√∫nel'
            };
            for (const [wrong, right] of Object.entries(replacements)) {
                fixed = fixed.split(wrong).join(right);
            }
            return fixed;
        };

        document.getElementById('fs-edit').onclick = () => {
            const song = showData.songs[currentIndex];
            document.getElementById('editor-input').value = activeMode === 'lyrics' ? (song.lyrics || '') : (song.notes || '');
            document.getElementById('editor-input').placeholder = activeMode === 'lyrics' ? "Cole aqui a letra..." : "Digite aqui suas Notas";
            btnSearchWeb.style.display = activeMode === 'lyrics' ? 'flex' : 'none';
            editorUI.style.display = 'flex';
        };

        // --- L√ìGICA DE BUSCA DE LETRAS INCORPORADA NO BOT√ÉO ---
        btnSearchWeb.onclick = async () => {
            const songNameRaw = showData.songs[currentIndex].name;
            const cleanName = songNameRaw.replace(/\s[A-G][#b]?m?$/i, '').trim();
            
            let defaultArtist = "";
            let defaultTitle = cleanName;
            if (cleanName.includes('-')) {
                const parts = cleanName.split('-');
                defaultArtist = parts[0].trim();
                defaultTitle = parts[1].trim();
            }

            const artist = prompt(`Buscar letra para: ${defaultTitle}\nQual o nome do artista/banda?`, defaultArtist);
            if (!artist) return;

            const originalBtnHtml = btnSearchWeb.innerHTML;
            btnSearchWeb.innerHTML = "‚è≥ BUSCANDO...";
            btnSearchWeb.disabled = true;

            try {
                const response = await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(artist.trim())}/${encodeURIComponent(defaultTitle)}`);
                const data = await response.json();
                
                if (data.lyrics) {
                    const lyricsFixed = fixEncoding(data.lyrics);
                    document.getElementById('editor-input').value = lyricsFixed;
                    toast("Letra importada com sucesso!");
                } else {
                    toast("Letra n√£o encontrada na base de dados.");
                }
            } catch (error) {
                toast("Erro ao buscar a letra. Verifique a internet.");
            } finally {
                btnSearchWeb.innerHTML = originalBtnHtml;
                btnSearchWeb.disabled = false;
            }
        };

        document.getElementById('editor-save-btn').onclick = () => {
            const txt = document.getElementById('editor-input').value;
            if (activeMode === 'lyrics') showData.songs[currentIndex].lyrics = txt;
            else showData.songs[currentIndex].notes = txt;
            editorUI.style.display = 'none';
            openFS(activeMode);
            updatePalco();
        };

        document.getElementById('nav-save').onclick = () => {
            const currentTitle = document.getElementById('show-title-input').value.trim() || "Meu Show";
            const name = prompt("Salvar repert√≥rio como:", currentTitle);
            if (!name) return;
            showData.title = name;
            document.getElementById('show-title-input').value = name;
            let saved = JSON.parse(localStorage.getItem('saved_setlists_pro') || "[]");
            saved = saved.filter(s => s.title !== name);
            saved.unshift(JSON.parse(JSON.stringify(showData)));
            localStorage.setItem('saved_setlists_pro', JSON.stringify(saved.slice(0, 15)));
            toast("Salvo!");
        };

        document.getElementById('nav-share').onclick = async () => {
            toast("Gerando link...");
            
            const compactData = {
                t: showData.title,
                s: showData.songs.map(song => ({ n: song.name, l: song.lyrics || "", o: song.notes || "" }))
            };
            
            const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(compactData))));
            const longUrl = window.location.origin + window.location.pathname + "?data=" + encodeURIComponent(encoded);
            
            let finalUrl = longUrl;

            try {
                if (longUrl.length < 4000) { 
                    const res = await fetch(`https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}`);
                    const data = await res.json();
                    if(data.shorturl) {
                        finalUrl = data.shorturl;
                    }
                }
            } catch(e) { console.log("N√£o foi poss√≠vel encurtar o link", e); }

            const shareText = `Confira o repert√≥rio: ${showData.title || 'Meu Show'}\n\n`;

            if(navigator.share) {
                navigator.share({ 
                    title: 'Setlist Pro', 
                    text: shareText,
                    url: finalUrl 
                }).catch(err => console.log(err));
            } else { 
                navigator.clipboard.writeText(shareText + finalUrl); 
                toast("Link copiado!"); 
            }
        };

        function startVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;
            if (recognition) { try { recognition.stop(); } catch(e){} }
            recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR'; recognition.continuous = true; recognition.interimResults = false;
            recognition.onresult = (event) => {
                const last = event.results.length - 1;
                const msg = event.results[last][0].transcript.toLowerCase();
                if (msg.includes("pr√≥xima") || msg.includes("proxima") || msg.includes("musica") || msg.includes("m√∫sica")) {
                    if (currentIndex < showData.songs.length - 1) {
                        currentIndex++; updatePalco();
                        if (fsUI.style.display === 'flex') openFS(activeMode);
                    }
                }
            };
            recognition.onend = () => {
                if (palcoUI.style.display === 'block' && micToggle.checked) { try { recognition.start(); } catch(e) {} }
            };
            try { recognition.start(); } catch(e) {}
        }

        document.getElementById('btn-start').onclick = async () => {
            const lines = document.getElementById('setlist-input').value.split('\n').filter(l => l.trim());
            if (!lines.length) return alert("Adicione as m√∫sicas!");
            const newSongs = lines.map(line => {
                const songName = line.trim();
                const existing = showData.songs.find(s => s.name === songName);
                return { name: songName, lyrics: existing ? existing.lyrics : "", notes: existing ? existing.notes : "" };
            });
            showData.title = document.getElementById('show-title-input').value.trim();
            showData.songs = newSongs;
            currentIndex = 0; scrollSpeed = 0; document.getElementById('speed-val').textContent = "0";
            startUI.style.display = 'none'; palcoUI.style.display = 'block'; menuBtn.style.display = 'none';
            updatePalco();
            
            requestWakeLock(); 
            
            if (micToggle.checked) startVoiceRecognition();
        };
    </script>
</body>
</html>